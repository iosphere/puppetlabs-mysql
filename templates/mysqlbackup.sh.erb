#!/bin/sh
#
# MySQL Backup Script
#  Dumps mysql databases to a file for another backup tool to pick up.
#
# MySQL code:
# GRANT SELECT, RELOAD, LOCK TABLES ON *.* TO 'user'@'localhost'
# IDENTIFIED BY 'password';
# FLUSH PRIVILEGES;
#
##### START CONFIG ###################################################

USER=<%= backupuser %>
PASS=<%= backuppassword %>
DIR=<%= backupdir %>

##### STOP CONFIG ####################################################
PATH=/usr/bin:/usr/sbin:/bin:/sbin
#
# Delete old backups, which are older than 1 day, if we have newer backups
if [ "$(( $(date +"%s") - $(stat -c "%Y" /var/backup/LAST_BACKUP) ))" -lt "86400" ];
then
    find $DIR -mtime +1 -exec rm -f {} \;
fi

mysqldump -u${USER} -p${PASS} --opt --flush-logs --single-transaction \
 --all-databases <% if backupcompress %>| bzcat -zc <% end %>> ${DIR}/mysql_backup_`date +%Y%m%d-%H%M%S`.sql<% if backupcompress %>.bz2<% end  %>

